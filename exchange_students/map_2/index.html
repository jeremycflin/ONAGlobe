<!DOCTYPE html>
<meta charset='utf-8'>
<html>
<style>

.baseMap{
  stroke-width:0.8px;
  stroke:white;
  fill:#E4E5E6;
  opacity:0.9;
}

.cities_start{
  fill:rgba(199,70,70,.8);
}

.cities_end{
  fill:rgba(29, 168, 183, 1);
  }

.line{
/*  stroke:rgba(0, 0, 0, 0.3);*/
  stroke:rgba(199,70,70,.7);
  stroke-width:5px;
  fill:none;
/*  stroke-dasharray:3, 3;*/
}

.geo-globe {
  fill: rgba(236,249,255,0.8);
}

.bar{
 opacity:0.7;
}

#map{
/*  width:800px;*/
}

#chart{
/*  width:800px;*/
/*  height:300px;*/
  position:absolute;
  margin-top: -100px;
}

.x_axis path {
  display: none;
}

.x_axis{
  font-size: 0.6em;
}

.y_axis {
  display:none;
}

.active{
/*  fill:rgba(29, 168, 183, .9);*/
  fill:black !important;
  opacity:0.8;
/*  fill:rgba(199,70,70,.8);*/
}

.lineActive{
  stroke:rgba(0, 0, 0, .8);;
}

.dotActive{
  fill:rgba(0, 0, 0, .7);
}

.title{
  font-size:22px;
  font-weight: 600;
  font-family: "Helvetica Neue";
  fill:black;
  opacity: 0.8;
  margin-bottom: 50px;
}

.value{
  font-size:18px;
  font-family: "Helvetica Neue";
  /*fill:rgba(29, 168, 183, 1);*/
  opacity: 0.6;
  fill:black;
  font-weight: 500;
}


.legend{
  fill:black;
}


/*.y_axis line{
  stroke: #fdfdfd;
  stroke-width:2.5px;
}*/
</style>
<body>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src='arc.js/arc.js'></script>
<div id ='map'></div>
<!-- <div id ='chart'></div> -->
<script>
function drawGraphic(){
  ////////////////////////////////
  ////////////////////////////////  
  // Global variables
  ////////////////////////////////
  ////////////////////////////////

  // I followed Mike Bostock's margin convention to set margins first, 
  // and then set the width and height based on margins.
  // Here's the link to the margin convention 
  // http://bl.ocks.org/mbostock/3019563

  var margin = {top: 30, right: 30, bottom: 30, left: 30},
    barMargin = {top:10, right: 30, bottom: 20, left: 100},
    width = 800 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom,
    barHeight = 180 - barMargin.top - barMargin.bottom;

  var z = d3.scale.ordinal().range([
    "lightpink", "lightpink","lightpink",
    "#4b818c","#4b818c","#4b818c",
    "darkgray", "darkgray","darkgray",
    "#6baed6","#6baed6","#6baed6",  
    "#EDDA74", "#EDDA74", "#EDDA74",
    "#949494","#949494","#949494",
    "#85BB65","#85BB65","#85BB65",
    "#F2BB66","#F2BB66","#F2BB66",
    "#c5b0d5","#c5b0d5","#c5b0d5",
    "#b37c71","#b37c71","#b37c71",
    "#98df8a","#98df8a","#98df8a",
    "#a55194","#a55194","#a55194",
    "#fe9d89","#fe9d89","#fe9d89",
    "lightblue","lightblue","lightblue",
    "#ce6dbd","#ce6dbd","#ce6dbd",
    "#8c6d31","#8c6d31","#8c6d31",
    "#5254a3","#5254a3","#5254a3",
    "#17becf","#17becf","#17becf",
    "#3182bd","#3182bd","#3182bd",
    "#de9ed6","#de9ed6","#de9ed6"
    ])



  
  // This is the projection for the flat map
  // var projection = d3.geo.mercator()
  //   // .center([121.0, 23.5])
  //   .translate([width / 2, height / 1.5])
  //   .scale(125); // feel free to tweak the number for scale and see the changes

  //This is the project for the globe 
  var projection =  d3.geo.orthographic()
    .scale(280)
    .translate([400,300])
    .clipAngle(90)
    .precision(0.5);

  // var path = d3.geo.path()
  //   .projection(projection);

  var path = d3.geo.path()
    .projection(projection)
    // .pointRadius(function(d) { return d.radius; });

  // Create a voronoi layer for better mouse interaction experience
  // For more reading on voronoi, check out 
  // http://www.visualcinnamon.com/2015/07/voronoi.html
  // var voronoi = d3.geom.voronoi()
  //   .x(function(d) { return d.x; })
  //   .y(function(d) { return d.y; })
  //   .clipExtent([[0, 0], [width, height]]);

  //Create a box for text  
  var box1, box2, box3, box4;

  // var country;

  ////////////////////////////////
  ////////////////////////////////  
  // Bar chart global variables
  ////////////////////////////////
  ////////////////////////////////
  var barX = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);

  // var barY = d3.scale.linear()
  //   .range([height,0]);

  var barY = d3.scale.linear()
    .range([barHeight,0]);

  var barXAxis = d3.svg.axis()
    .scale(barX)
    .orient('bottom');

  var barYAxis = d3.svg.axis()
    .scale(barY)
    .orient('left')


  var svg = d3.select('#map').append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom)
    .attr('class', 'graph-svg-component')
    .call(responsivefy)// Call function responsivefy to make the graphic reponsive according to the window width/height
    .append('g')
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

  var svgBar = d3.select('#map').append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', barHeight + barMargin.top + barMargin.bottom)
    .attr('class', 'barChart')
    // .call(test)
        // .style('fill','green')
    .call(responsivefy)
    .append('g')
    .attr('transform', 'translate(' + margin.left + ',' + barMargin.top + ')')

  var backgroundCircle = svg.append('circle')
      .attr('cx', width / 1.85)
      // .attr('cx', width / 1.6573)
      .attr('cy', height / 1.84099)
      .attr('r', 0)
      .attr('class', 'geo-globe');

  backgroundCircle.attr('r', projection.scale());

  ////////////////////////////////
  ////////////////////////////////  
  // Queue: queue is an asynchronous helper library for JavaScrip 
  // It helps coders to easily load multiple datasets 
  // Here's the link to queue github repository:
  // https://github.com/mbostock/queue
  ////////////////////////////////
  ////////////////////////////////

  queue()
      .defer(d3.json, 'data/world_countries.json')// load geojson/topojson data
      .defer(d3.csv, 'data/exchange_student.csv')
      .defer(d3.csv, 'data/data_school.csv')
      .await(ready);

  function ready(error, world, data, school) {

    if (error) throw error;

    school.forEach(
      function(d){
        d.count = +d.count;
      }
    );

    barX.domain(school.map(function(d){ return d.top_three;}))
    barY.domain([0, d3.max(school, function(d){ return d.count;})])

    svgBar.selectAll('.bar')
      .data(school)
      .enter()
      .append('rect')
         // .filter(function(d) { return d.year == 101 })
      .attr('class', 'bar')
      .attr('x', function(d) { return barX(d.top_three); })
      .attr('width', barX.rangeBand())
      // .attr('y', height)
      // .transition()
      // .duration(2000)
      .attr('y', function(d) { return barY(d.count); })
      .attr('height', function(d) { return barHeight - barY(d.count); })
      // .attr('y', function(d) { return (barY(d.count))*2; })
      // .attr('height', function(d) { return (barHeight - barY(d.count))*2; })
      .style("fill", function(d, i) { return z(i); })
      .on('mouseover',function(d){

          d3.select(this)
            .classed("active", true);
          d3.select(".country")
            .text(d.end_country)
          d3.select(".count")
            .text(d.count)
          d3.select(".url")
            .text(d.url)
          d3.select(".school")
            .text(d.top_three)

          // d3.select(".dot")
          //   .classed("lineActive",true)
          
        })
      .on('mouseout', function(d){
        // tip.hide(d);

        d3.select(this)
          .classed("active", false)

        d3.select(".line")
            .classed("lineActive",false)

        // d3.select(".country")
        //   .text(d.end_country)

        // d3.select(".count")
        //   .text(d.count)

        // d3.select(".url")
        //   .text(d.url)
      })

    // svgBar.append('g')
    //   .attr('class', 'x_axis')
    //   .attr('transform', 'translate(0,' + barHeight + ')')
    //   .call(barXAxis)
      // .selectAll('text')
      // .attr('y', 0)
      // .attr('x', 9)
      // .attr('dy', '.35em')
      // .attr('transform', 'rotate(90)')
      // .style('text-anchor', 'start');

    // svgBar.append('g')
    //   .attr('class', 'y_axis')
    //   .call((barYAxis).scale(barY).innerTickSize (-barHeight))
      // .append('text')
      // .attr('transform', 'rotate(-90)')
      // .attr('y', 8)
      // .attr('dy', '.71em')
      // .style('text-anchor', 'end')
      // .text('Number of Gas Plants')
      // .style('font-weight',500);

    // svgBar.append("rect")
    //   .attr('width',width/20)
    //   .attr('height','10')
    //   .attr('class','legend')
    //   .attr('x',10)
    //   .attr('y',barHeight + 5)


    data.forEach(
      function(d){
        d.end_lat = +d.end_lat;
        d.end_long = +d.end_long;
        d.start_lat = +d.start_lat;
        d.start_long = +d.start_long;

        d.count = + d.count;

        d.greatcircle = new arc.GreatCircle({x:d.start_long, y:d.start_lat}, {x:d.end_long, y:d.end_lat});
        d.line = d.greatcircle.Arc(100, {offset:10});
        d.arc = d.line.json();

        // svg.append("path")
        //   .datum({type: "Point", coordinates: [d.end_long, d.end_lat]})
        //   .attr("d", path.pointRadius(8));
      }
    );

   
    svg.selectAll('path')
       .data(world.features)
       .enter()
       .append('path')
       .attr('d', path)
       // .append('g')
       .attr('class','baseMap');

    // svg.selectAll('.cities_start')
    //    .data(data)
    //    .enter()
    //    .append('circle')
    //    .attr('cx', function(d){ return projection([d.start_long, d.start_lat])[0]})
    //    .attr('cy', function(d){ return projection([d.start_long, d.start_lat])[1]})
    //    .attr('r', '5')
    //    // .append('g')
    //    .attr('class','cities_start');

    // svg.selectAll('.cities_end')
    //    .data(data)
    //    .enter()
    //    .append('circle')
    //    .attr('cx', function(d){ return projection([d.end_long, d.end_lat])[0]})
    //    .attr('cy', function(d){ return projection([d.end_long, d.end_lat])[1]})
    //    .attr('r', '5')
    //    // .append('g')
    //    .attr('class','cities_end')
    //    .on('mouseover',function(d){
    //       // tip.show(d);

    //       d3.select(this)
    //         .style("opacity", 0.9)
    //         .style("stroke","black")
    //         .style("stroke-width",1.5);
    //     })
    //     .on('mouseout', function(d){
    //       // tip.hide(d);

    //       d3.select(this)
    //         .style("opacity", 0.6)
    //         .style("stroke","white")
    //         .style("stroke-width",0.5);
    //     })

    svg.selectAll(".cities_end")
      .data(data)
      .enter().append("path")
      // .datum(function(d) {
      //   return {type: "Point", coordinates: [d.end_long, d.end_lat], radius: 8};
      // })
      // .attr("class", "point cities_end")
      .attr("d", path);
 

    // svgBar.selectAll('.bar')
    //   .data(school)
    //   .enter()
    //   .append('rect')
    //   .attr('class', 'bar')
    //   .attr('x', function(d) { return barX(d.top_three); })
    //   .attr('width', barX.rangeBand())
    //   // .attr('y', height)
    //   // .transition()
    //   // .duration(2000)
    //   .attr('y', function(d) { return barY(d.count); })
    //   .attr('height', function(d) { return barHeight - barY(d.count); })
    //   // .attr('y', function(d) { return (barY(d.count))*2; })
    //   // .attr('height', function(d) { return (barHeight - barY(d.count))*2; })
    //   .style("fill", function(d, i) { return z(i); })
    //   .on('mouseover',function(d){

    //       d3.select(this)
    //         .classed("active", true);
    //       d3.select(".country")
    //         .text(d.end_country)
    //       d3.select(".count")
    //         .text(d.count)
    //       d3.select(".url")
    //         .text(d.url)

    //       // d3.select(".dot")
    //       //   .classed("lineActive",true)
          
    //     })


    // svg.selectAll(".cities_start")
    //   .data(data)
    //   .enter().append("path")
    //   .datum(function(d) {
    //     return {type: "Point", coordinates: [d.end_long, d.end_lat], radius: 5};
    //   })
    //   .attr("class", "point cities_start")
    //   .attr("d", path);  

    svg.append('g')
       .attr('class', 'line')
       .selectAll('.arcs')
       .data(data.map(function(d){ return d.arc; }))
       .enter()
       .append('path')
       .attr('d', path)
       .data(data)
       .on('mouseover',function(d){
       
          d3.select(this)
            .classed("lineActive", true);
          d3.select(".country")
            .text(d.end_country);
          d3.select(".count")
            .text(d.count)
          d3.select(".url")
            .text(d.url)
          d3.select(".school")
            .text(d.top_three)


        })
      .on('mouseout',function(d){   
          d3.select(this)
            .classed("lineActive", false);  
          d3.select(".country")
            .text("測試");  
        })




    // var voronoiGroup = svg.append('g')
    //   .attr('class', 'voronoi');

    // voronoiGroup.selectAll('circles')
    //   .data(voronoi(data))
    //   .enter().append('path')
    //   .attr('d', function(d) { return 'M' + d.join('L') + 'Z'; })
    //   .datum(function(d) { return d.point; })
    //   // .on('mouseover', mouseover)
    //   // .on('mouseout', mouseout);

    // Tool box
    box1 = svg.append("text")
      .attr("class","title")
      // .attr("x", width * 0.32)
      // .attr("y", height * 0.999 + 40)
      .attr("x", 10)
      .attr("y", height * 0.8)
      .text('國家:');

    svg.append("text")
      .attr("class","country value")
      // .attr("x", width * 0.32)
      // .attr("y", height * 0.999 + 40)
      .attr("x", 80)
      .attr("y", height * 0.8)
      .text('測試');

    box3 = svg.append("text")
      .attr("class","title")
      // .attr("x", width * 0.32)
      // .attr("y", height * 0.999 + 40)
      .attr("x", 10)
      .attr("y", height * 0.9)
      .text('人數:');

    svg.append("text")
      .attr("class","value count")
      // .attr("x", width * 0.32)
      // .attr("y", height * 0.999 + 40)
      .attr("x", 80)
      .attr("y", height * 0.9)
      .text('測試');

    box2 = svg.append("text")
      .attr("class","title")
      // .attr("x", width * 0.32)
      // .attr("y", height * 0.999 + 40)
      .attr("x", 10)
      .attr("y", height * 0.85)
      .text('學校:');

    svg.append("text")
      .attr("class","value school")
      // .attr("x", width * 0.32)
      // .attr("y", height * 0.999 + 40)
      .attr("x", 80)
      .attr("y", height * 0.85)
      .text('測試');

    box4 = svg.append("text")
      .attr("class","title")
      // .attr("x", width * 0.32)
      // .attr("y", height * 0.999 + 40)
      .attr("x", 10)
      .attr("y", height * 0.95)
      .text('網址:');

    svg.append("text")
      .attr("class","value url")
      // .attr("x", width * 0.32)
      // .attr("y", height * 0.999 + 40)
      .attr("x", 80)
      .attr("y", height * 0.95)
      .text('測試');


  }

   d3.select('svg').call( //drag on the svg element
      d3.behavior.drag()
        .origin(function() {
          var r = projection.rotate(); 
          return {x: r[0], y: -r[1]}; //starting point
        })
        .on('drag', function() {
          var r = projection.rotate();
          /* update retation angle */
          projection.rotate([d3.event.x, -d3.event.y, r[2]]);
          /* redraw the map and circles after rotation */
          svg.selectAll('path').attr('d',path);

          // svg.selectAll('.arcs').data(data.map(function(d){ return d.arc; }))
          // .enter().append('path').attr('d',path);


          // svg.selectAll('.cities_start')
          //   .attr('cx', function(d){ return projection([d.start_long, d.start_lat])[0]})
          //   .attr('cy', function(d){ return projection([d.start_long, d.start_lat])[1]})

          // svg.selectAll('.cities_end')
          //   .attr('cx', function(d){ return projection([d.end_long, d.end_lat])[0]})
          //   .attr('cy', function(d){ return projection([d.end_long, d.end_lat])[1]})
      
        })
    );

  function responsivefy(svg) {
    var container = d3.select(svg.node().parentNode),
        width = parseInt(svg.style('width')),
        height = parseInt(svg.style('height')),
        aspect = width / height;

    svg.attr('viewBox', '0 0 ' + width + ' ' + height)
        .attr('perserveAspectRatio', 'xMinYMid')
        .call(resize);

    d3.select(window).on('resize', resize);

    function resize() {
        var targetWidth = parseInt(container.style('width'));
        svg.attr('width', targetWidth);
        svg.attr('height', Math.round(targetWidth / aspect));
    }
  }

}


drawGraphic();



</script>

</body>
</html>